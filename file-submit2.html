<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶æ”¶é›†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray: #6b7280;
            --gray-light: #f3f4f6;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 95vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-running { background: var(--success); }
        .status-paused { background: var(--warning); }
        .status-ended { background: var(--danger); }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding: 40px 20px;
        }

        .role-cards {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .role-card {
            background: var(--gray-light);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            width: 280px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .role-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .role-card h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .role-card p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .login-form {
            background: var(--gray-light);
            padding: 25px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            display: none;
        }

        .login-form.active {
            display: block;
            animation: slideIn 0.3s;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--gray);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Visitor Panel */
        .visitor-panel {
            display: none;
        }

        .visitor-panel.active {
            display: block;
        }

        .submit-section {
            background: var(--gray-light);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 15px 0;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: #e0f2fe;
        }

        .file-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .file-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: white;
        }

        .file-preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .file-preview-item .file-icon {
            width: 100%;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            background: var(--gray-light);
            color: var(--gray);
        }

        .file-name {
            padding: 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: white;
        }

        .remove-file {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Host Panel */
        .host-panel {
            display: none;
        }

        .host-panel.active {
            display: block;
        }

        .host-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .control-panel {
            background: var(--gray-light);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .control-item {
            margin-bottom: 15px;
        }

        .control-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .list-container {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .list-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background: var(--gray-light);
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .item-status {
            font-size: 0.85rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .status-submitted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fee2e2;
            color: #991b1b;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .file-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .file-preview-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .modal-body img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .modal-body .file-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 10px;
            min-width: 250px;
        }

        .notification.show {
            display: flex;
            animation: slideInRight 0.3s;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.info {
            border-left: 4px solid var(--primary);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                max-height: 100vh;
                border-radius: 0;
            }

            .header {
                padding: 15px;
            }

            .main-content {
                padding: 15px;
            }

            .role-cards {
                flex-direction: column;
                width: 100%;
            }

            .role-card {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* ======== æ‰‹æœºç«¯æ·±åº¦ä¼˜åŒ–ï¼ˆæˆ¿ä¸»ç•Œé¢é‡ç‚¹ï¼‰ ======== */
@media (max-width: 768px) {

    /* æ•´ä½“èƒŒæ™¯æ”¹ä¸º App é£æ ¼ */
    body {
        background: #f5f6fa;
        padding: 0;
    }

    /* é¡¶éƒ¨ä¸è¦å¤ªé«˜ */
    .header h1 {
        font-size: 1.1rem;
    }

    /* ===== ç»Ÿè®¡å¡ç‰‡ï¼šä»â€œå¤§å¡â€å˜â€œä¿¡æ¯æ¡â€ ===== */
    .stats-grid {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 15px;
    }

    .stat-card {
        padding: 12px 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: left;
    }

    .stat-value {
        font-size: 18px;
        font-weight: 700;
    }

    .stat-label {
        font-size: 13px;
        margin-top: 0;
        color: #666;
    }

    /* ===== æ–‡ä»¶æ•°é‡é™åˆ¶é‚£ä¸€è¡Œ ===== */
    .control-item {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .control-item label {
        width: 100%;
        font-size: 14px;
        color: #555;
        margin-bottom: 4px;
    }

    .control-item input {
        width: 80px;
        padding: 8px;
    }

    .control-item .btn {
        flex: 1;
        height: 38px;
        font-size: 14px;
    }

    /* ===== å¯åŠ¨ / æš‚åœ / ç»“æŸæŒ‰é’® ===== */
    .control-panel .btn {
        height: 42px;
        font-size: 15px;
    }

    /* ===== æäº¤äººåˆ—è¡¨ï¼šå¡ç‰‡åŒ– ===== */
    .list-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .item-status {
        align-self: flex-start;
    }

    .item-actions {
        width: 100%;
        display: flex;
        gap: 6px;
    }

    .item-actions .btn {
        flex: 1;
        font-size: 12px;
        padding: 8px 0;
    }

    /* ===== Tab æŒ‰é’®ä¸è¦å¤ªæŒ¤ ===== */
    .host-tabs {
        gap: 5px;
    }

    .tab-btn {
        font-size: 14px;
        padding: 10px 12px;
    }

    /* ===== ç©ºçŠ¶æ€åˆ«å¤ªå¤§ ===== */
    .empty-state {
        padding: 25px 10px;
    }

    .empty-state-icon {
        font-size: 2.2rem;
    }
}


        .hidden {
            display: none !important;
        }

        .import-section {
            background: var(--gray-light);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .file-input-label:hover {
            background: var(--primary-dark);
        }

        input[type="file"] {
            display: none;
        }

        .limit-info {
            font-size: 0.9rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 id="headerTitle">ğŸ“ æ–‡ä»¶æ”¶é›†ç³»ç»Ÿ</h1>
            <div id="headerStatus"></div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Login Screen -->
            <div id="loginScreen" class="login-screen">
                <h2 style="color: var(--primary);">æ¬¢è¿ä½¿ç”¨æ–‡ä»¶æ”¶é›†ç³»ç»Ÿ</h2>
                <p style="color: var(--gray); text-align: center; max-width: 500px;">
                    è¯·é€‰æ‹©æ‚¨çš„èº«ä»½è¿›å…¥ç³»ç»Ÿ
                </p>

                <div class="role-cards">
                    <div class="role-card" onclick="selectRole('visitor')">
                        <h2>ğŸ‘¥ è®¿å®¢</h2>
                        <p>æäº¤æ–‡ä»¶æˆ–å›¾ç‰‡ï¼ŒæŸ¥çœ‹æˆ‘çš„æäº¤</p>
                    </div>
                    <div class="role-card" onclick="selectRole('host')">
                        <h2>ğŸ  æˆ¿ä¸»</h2>
                        <p>ç®¡ç†æ”¶é›†ä»»åŠ¡ï¼ŒæŸ¥çœ‹æ‰€æœ‰æäº¤</p>
                    </div>
                </div>

                <!-- Visitor Login -->
                <div id="visitorLoginForm" class="login-form">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">è®¿å®¢ç™»é™†</h3>
                    <div class="form-group">
                        <label>æ‚¨çš„å§“å</label>
                        <input type="text" id="visitorName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="loginVisitor()">è¿›å…¥</button>
                        <button class="btn btn-secondary" onclick="backToRoleSelect()">è¿”å›</button>
                    </div>
                </div>

                <!-- Host Login -->
                <div id="hostLoginForm" class="login-form">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">æˆ¿ä¸»ç™»é™†</h3>
                    <div class="form-group">
                        <label>ç®¡ç†å‘˜å¯†ç </label>
                        <input type="password" id="hostPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="loginHost()">ç™»é™†</button>
                        <button class="btn btn-secondary" onclick="backToRoleSelect()">è¿”å›</button>
                    </div>
                </div>
            </div>

            <!-- Visitor Panel -->
            <div id="visitorPanel" class="visitor-panel">
                <div class="submit-section">
                    <h3 style="margin-bottom: 15px;">æäº¤æ–‡ä»¶</h3>
                    <div id="visitorInfo" style="margin-bottom: 15px; color: var(--gray);"></div>
                    <div id="uploadArea" class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 3rem; margin-bottom: 10px;">â˜ï¸</div>
                        <div style="font-weight: 600; margin-bottom: 5px;">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">æ”¯æŒå›¾ç‰‡å’Œå¸¸è§æ–‡ä»¶æ ¼å¼</div>
                        <div id="limitInfo" class="limit-info"></div>
                    </div>
                    <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.txt">
                    <div class="btn-group">
                        <button class="btn btn-primary" id="submitFilesBtn" onclick="submitFiles()" disabled>
                            æäº¤æ–‡ä»¶
                        </button>
                        <button class="btn btn-secondary" onclick="logoutVisitor()">é€€å‡º</button>
                    </div>
                </div>

                <div id="visitorFilesSection" style="display: none;">
                    <h3 style="margin-bottom: 15px;">æˆ‘çš„æäº¤</h3>
                    <div id="visitorFilesList" class="file-preview-grid"></div>
                </div>
            </div>

            <!-- Host Panel -->
            <div id="hostPanel" class="host-panel">
                <!-- Control Panel -->
                <div class="control-panel">
                    <h3 style="margin-bottom: 15px;">æ”¶é›†æ§åˆ¶</h3>
                    <div class="btn-group" style="margin-bottom: 15px;">
                        <button class="btn btn-success" id="startBtn" onclick="updateCollectionStatus('running')">ğŸš€ å¯åŠ¨æ”¶é›†</button>
                        <button class="btn btn-warning" id="pauseBtn" onclick="updateCollectionStatus('paused')">â¸ï¸ æš‚åœæ”¶é›†</button>
                        <button class="btn btn-danger" id="endBtn" onclick="updateCollectionStatus('ended')">ğŸ›‘ ç»“æŸæ”¶é›†</button>
                    </div>
                    <div class="control-item">
                        <label>æ¯äººæ–‡ä»¶æ•°é‡é™åˆ¶</label>
                        <input type="number" id="fileLimit" min="1" value="3" style="max-width: 150px;">
                        <button class="btn btn-primary btn-small" onclick="updateFileLimit()">æ›´æ–°é™åˆ¶</button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalSubmitters">0</div>
                        <div class="stat-label">æ€»äººæ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="submittedCount">0</div>
                        <div class="stat-label">å·²æäº¤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingCount">0</div>
                        <div class="stat-label">å¾…æäº¤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalFiles">0</div>
                        <div class="stat-label">æ–‡ä»¶æ€»æ•°</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="host-tabs">
                    <button class="tab-btn active" onclick="switchTab('submitters')">ğŸ“‹ æäº¤äººç®¡ç†</button>
                    <button class="tab-btn" onclick="switchTab('files')">ğŸ“„ æ–‡ä»¶ç®¡ç†</button>
                    <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ é«˜çº§è®¾ç½®</button>
                </div>

                <!-- Tab: Submitters -->
                <div id="tab-submitters" class="tab-content active">
                    <div class="btn-group" style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="showAddSubmitterModal()">â• æ·»åŠ äººå‘˜</button>
                        <button class="btn btn-secondary" onclick="showImportModal()">ğŸ“¥ å¯¼å…¥åå•</button>
                        <button class="btn btn-danger" onclick="clearSubmitters()">ğŸ—‘ï¸ æ¸…ç©ºåå•</button>
                    </div>

                    <div class="list-container" id="submittersList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div>æš‚æ— æäº¤äººï¼Œè¯·æ·»åŠ æˆ–å¯¼å…¥åå•</div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Files -->
                <div id="tab-files" class="tab-content">
                    <div class="btn-group" style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="exportAllFiles()">ğŸ“¦ å¯¼å‡ºå…¨éƒ¨</button>
                        <button class="btn btn-danger" onclick="clearAllFiles()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶</button>
                    </div>

                    <div id="filesList" class="list-container">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“„</div>
                            <div>æš‚æ— æ–‡ä»¶æäº¤</div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Settings -->
                <div id="tab-settings" class="tab-content">
                    <div class="import-section">
                        <h3 style="margin-bottom: 15px;">å±é™©æ“ä½œåŒº</h3>
                        <p style="color: var(--danger); margin-bottom: 15px; font-weight: 600;">
                            âš ï¸ ä»¥ä¸‹æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼
                        </p>
                        <div class="btn-group">
                            <button class="btn btn-warning" onclick="resetCollection()">ğŸ”„ é‡ç½®æ”¶é›†å†…å®¹</button>
                            <button class="btn btn-danger" onclick="resetAll()">ğŸ’¥ é‡ç½®å…¨éƒ¨ï¼ˆå±é™©ï¼‰</button>
                        </div>
                    </div>

                    <div class="import-section">
                        <h3 style="margin-bottom: 15px;">ç³»ç»Ÿä¿¡æ¯</h3>
                        <div id="systemInfo" style="color: var(--gray); line-height: 1.8;"></div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="logoutHost()">é€€å‡ºæˆ¿ä¸»</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Submitter Modal -->
    <div id="addSubmitterModal" class="file-preview-modal">
        <div class="modal-content" style="max-width: 400px;">
            <button class="modal-close" onclick="closeModal('addSubmitterModal')">Ã—</button>
            <h3 style="margin-bottom: 20px;">æ·»åŠ æäº¤äºº</h3>
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="newSubmitterName" placeholder="è¾“å…¥å§“å">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addSubmitter()">æ·»åŠ </button>
                <button class="btn btn-secondary" onclick="closeModal('addSubmitterModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="file-preview-modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeModal('importModal')">Ã—</button>
            <h3 style="margin-bottom: 20px;">å¯¼å…¥åå•</h3>
            <p style="color: var(--gray); margin-bottom: 15px;">
                ä¸Šä¼ CSVæˆ–TXTæ–‡ä»¶ï¼Œæ¯è¡Œä¸€ä¸ªå§“åã€‚æ”¯æŒä»Excelå¤åˆ¶ç²˜è´´ã€‚
            </p>
            <div class="form-group">
                <label class="file-input-label" for="importFile">
                    ğŸ“ é€‰æ‹©æ–‡ä»¶
                </label>
               <input
  type="file"
  id="importFile"
  accept=".csv,.txt,.xls,.xlsx"
  onchange="handleImportFile(event)"
>

                <div id="importPreview" style="margin-top: 15px; color: var(--gray);"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="confirmImport()">ç¡®è®¤å¯¼å…¥</button>
                <button class="btn btn-secondary" onclick="closeModal('importModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="file-preview-modal">
        <div class="modal-content" style="max-width: 800px;">
            <button class="modal-close" onclick="closeModal('filePreviewModal')">Ã—</button>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // ==================== é…ç½®åŒºåŸŸ ====================
        // âš ï¸ è¯·æ›¿æ¢ä¸ºä½ çš„LeanCloudé…ç½®
        const LEAN_CONFIG = {
            appId: 'awjrq2pnF6yDBX2QT7Sq1dHQ-gzGzoHsz',      // æ›¿æ¢ä¸ºä½ çš„App ID
            appKey: 'WY6uq9q4hPthkwKX5JIHrlYk',    // æ›¿æ¢ä¸ºä½ çš„App Key
            serverURL: 'https://awjrq2pn.lc-cn-n1-shared.com' // æ›¿æ¢ä¸ºä½ çš„Server URL
        };

        // é»˜è®¤ç®¡ç†å‘˜å¯†ç ï¼ˆå»ºè®®ä¿®æ”¹ï¼‰
        const ADMIN_PASSWORD = '471695';

        // ==================== å…¨å±€çŠ¶æ€ ====================
        let currentUser = null; // å½“å‰ç”¨æˆ·ä¿¡æ¯ {role: 'visitor'|'host', name: string}
        let collectionStatus = 'paused'; // running, paused, ended
        let fileLimit = 3; // æ¯äººæ–‡ä»¶æ•°é‡é™åˆ¶
        let submittersCache = []; // ç¼“å­˜æäº¤äººåˆ—è¡¨
        let submissionsCache = []; // ç¼“å­˜æäº¤æ–‡ä»¶åˆ—è¡¨
        let tempImportData = []; // ä¸´æ—¶å¯¼å…¥æ•°æ®

        // ==================== LeanCloud åˆå§‹åŒ– ====================
        function initLeanCloud() {
            if (LEAN_CONFIG.appId === 'YOUR_APP_ID' || !LEAN_CONFIG.appId) {
                showNotification('âš ï¸ è¯·å…ˆé…ç½®LeanCloudä¿¡æ¯ï¼', 'error');
                return false;
            }
            try {
                AV.init({
                    appId: LEAN_CONFIG.appId,
                    appKey: LEAN_CONFIG.appKey,
                    serverURL: LEAN_CONFIG.serverURL
                });
                return true;
            } catch (error) {
                showNotification('LeanCloudåˆå§‹åŒ–å¤±è´¥ï¼š' + error.message, 'error');
                return false;
            }
        }

        // ==================== æ•°æ®æ¨¡å‹ ====================
        // å®šä¹‰LeanCloudæ•°æ®ç±»
        const CollectSettings = AV.Object.extend('CollectSettings');
        const Submitters = AV.Object.extend('Submitters');
        const Submissions = AV.Object.extend('Submissions');

        // ==================== é€šç”¨å‡½æ•° ====================
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoading(element) {
            if (element) {
                element.disabled = true;
                element.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
            }
        }

        function hideLoading(element, text) {
            if (element) {
                element.disabled = false;
                element.textContent = text;
            }
        }

        function formatDate(date) {
            return new Date(date).toLocaleString('zh-CN');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'ğŸ–¼ï¸';
            if (['pdf'].includes(ext)) return 'ğŸ“„';
            if (['doc', 'docx'].includes(ext)) return 'ğŸ“';
            if (['xls', 'xlsx'].includes(ext)) return 'ğŸ“Š';
            if (['txt'].includes(ext)) return 'ğŸ“ƒ';
            return 'ğŸ“';
        }

        // ==================== é¡µé¢å¯¼èˆª ====================
        function selectRole(role) {
            if (!initLeanCloud()) return;

            if (role === 'visitor') {
                document.getElementById('visitorLoginForm').classList.add('active');
                document.getElementById('hostLoginForm').classList.remove('active');
            } else {
                document.getElementById('hostLoginForm').classList.add('active');
                document.getElementById('visitorLoginForm').classList.remove('active');
            }
        }

        function backToRoleSelect() {
            document.getElementById('visitorLoginForm').classList.remove('active');
            document.getElementById('hostLoginForm').classList.remove('active');
        }

        function showPanel(panel) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('visitorPanel').classList.remove('active');
            document.getElementById('hostPanel').classList.remove('active');

            if (panel === 'visitor') {
                document.getElementById('visitorPanel').classList.add('active');
            } else if (panel === 'host') {
                document.getElementById('hostPanel').classList.add('active');
            }
        }

        // ==================== ç™»å½•ç³»ç»Ÿ ====================
        async function loginVisitor() {
            const name = document.getElementById('visitorName').value.trim();
            if (!name) {
                showNotification('è¯·è¾“å…¥å§“åï¼', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦åœ¨æäº¤äººåˆ—è¡¨ä¸­
            try {
                const query = new AV.Query('Submitters');
                query.equalTo('name', name);
                const result = await query.first();

                if (!result) {
                    showNotification('âŒ æ‚¨ä¸åœ¨æäº¤äººåå•ä¸­ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                    return;
                }

                if (result.get('hasSubmitted')) {
                    showNotification('âš ï¸ æ‚¨å·²æäº¤æ–‡ä»¶ï¼Œå¦‚éœ€ä¿®æ”¹è¯·è”ç³»ç®¡ç†å‘˜', 'warning');
                }

                currentUser = { role: 'visitor', name: name };
                showPanel('visitor');
                updateVisitorInfo();
                loadVisitorFiles();
                checkCollectionStatus();
            } catch (error) {
                showNotification('ç™»å½•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        function loginHost() {
            const password = document.getElementById('hostPassword').value;
            if (password === ADMIN_PASSWORD) {
                currentUser = { role: 'host' };
                showPanel('host');
                loadHostData();
                checkCollectionStatus();
            } else {
                showNotification('å¯†ç é”™è¯¯ï¼', 'error');
            }
        }

        function logoutVisitor() {
            currentUser = null;
            document.getElementById('visitorPanel').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('visitorLoginForm').classList.remove('active');
            document.getElementById('visitorName').value = '';
        }

        function logoutHost() {
            currentUser = null;
            document.getElementById('hostPanel').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('hostLoginForm').classList.remove('active');
            document.getElementById('hostPassword').value = '';
        }

        // ==================== è®¿å®¢åŠŸèƒ½ ====================
        function updateVisitorInfo() {
            const info = document.getElementById('visitorInfo');
            info.innerHTML = `ğŸ‘‹ æ¬¢è¿ï¼Œ<strong>${currentUser.name}</strong>ï¼è¯·æäº¤æ‚¨çš„æ–‡ä»¶ã€‚`;
        }

        async function loadVisitorFiles() {
            try {
                const query = new AV.Query('Submissions');
                query.equalTo('submitter', currentUser.name);
                const files = await query.find();

                if (files.length > 0) {
                    document.getElementById('visitorFilesSection').style.display = 'block';
                    const container = document.getElementById('visitorFilesList');
                    container.innerHTML = '';

                    files.forEach(file => {
                        const fileObj = file.get('file');
                        const item = createFilePreviewItem(fileObj, file.id, true);
                        container.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½è®¿å®¢æ–‡ä»¶å¤±è´¥:', error);
            }
        }

        // æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        let selectedFiles = [];

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

       async function handleFiles(files) {
    files = Array.from(files);

    // è·å–æ–‡ä»¶æ•°é‡é™åˆ¶
    const limitQuery = new AV.Query('CollectSettings');
    const settings = await limitQuery.first();
    const limit = settings ? settings.get('fileLimit') : 3;

    // æŸ¥è¯¢å·²æäº¤æ•°é‡
    const submitQuery = new AV.Query('Submissions');
    submitQuery.equalTo('submitter', currentUser.name);
    const existing = await submitQuery.find();

    const remaining = limit - existing.length - selectedFiles.length;

    if (remaining <= 0) {
        showNotification('å·²è¾¾åˆ°å¯ä¸Šä¼ æ–‡ä»¶ä¸Šé™', 'error');
        return;
    }

    // åªå–è¿˜èƒ½åŠ çš„æ•°é‡
    const canAddFiles = files.slice(0, remaining);

    // âœ… å…³é”®ï¼šè¿½åŠ ï¼Œè€Œä¸æ˜¯è¦†ç›–
    selectedFiles.push(...canAddFiles);

    if (selectedFiles.length === 0) {
        showNotification('æ²¡æœ‰å¯ä¸Šä¼ çš„æ–‡ä»¶ï¼', 'error');
        return;
    }

    displaySelectedFiles();
    document.getElementById('submitFilesBtn').disabled = false;
    updateLimitInfo();
}
        function displaySelectedFiles() {
            // ç§»é™¤æ—§çš„é¢„è§ˆ
            const oldPreviews = document.querySelectorAll('.selected-file-preview');
            oldPreviews.forEach(el => el.remove());

            const container = document.getElementById('uploadArea');
            const previewGrid = document.createElement('div');
            previewGrid.className = 'file-preview-grid selected-file-preview';
            previewGrid.style.marginTop = '15px';

            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    item.appendChild(img);
                } else {
                    const icon = document.createElement('div');
                    icon.className = 'file-icon';
                    icon.textContent = getFileIcon(file.name);
                    item.appendChild(icon);
                }

                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name;
                item.appendChild(fileName);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file';
                removeBtn.textContent = 'Ã—';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    selectedFiles.splice(index, 1);
                    displaySelectedFiles();
                    if (selectedFiles.length === 0) {
                        document.getElementById('submitFilesBtn').disabled = true;
                    }
                    updateLimitInfo();
                };
                item.appendChild(removeBtn);

                previewGrid.appendChild(item);
            });

            container.after(previewGrid);
        }

        async function updateLimitInfo() {
            const limitInfo = document.getElementById('limitInfo');
            const limitQuery = new AV.Query('CollectSettings');
            const settings = await limitQuery.first();
            const limit = settings ? settings.get('fileLimit') : 3;

            const submitQuery = new AV.Query('Submissions');
            submitQuery.equalTo('submitter', currentUser.name);
            const existing = await submitQuery.find();

            const remaining = limit - existing.length;
            limitInfo.textContent = `å·²æäº¤ ${existing.length}/${limit} ä¸ªæ–‡ä»¶ï¼Œè¿˜å¯ä¸Šä¼  ${remaining} ä¸ª`;
        }

        async function submitFiles() {
            if (selectedFiles.length === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼', 'error');
                return;
            }

            const btn = document.getElementById('submitFilesBtn');
            showLoading(btn);

            try {
                // æ£€æŸ¥æ”¶é›†çŠ¶æ€
                // æ£€æŸ¥æ”¶é›†çŠ¶æ€ï¼ˆåªå…è®¸ runningï¼‰
const statusQuery = new AV.Query('CollectSettings');
const settings = await statusQuery.first();

if (!settings || settings.get('status') !== 'running') {
    showNotification('å½“å‰æœªå¤„äºæ”¶é›†çŠ¶æ€ï¼Œæ— æ³•æäº¤æ–‡ä»¶ï¼', 'error');
    hideLoading(btn, 'æäº¤æ–‡ä»¶');
    return;
}


                // ä¸Šä¼ æ–‡ä»¶å¹¶åˆ›å»ºè®°å½•
                for (const file of selectedFiles) {
                    const avFile = new AV.File(file.name, file);
                    await avFile.save();

                    const submission = new Submissions();





                    submission.set('submitter', currentUser.name);
                    submission.set('file', avFile);
                    submission.set('fileName', file.name);
                    submission.set('fileType', file.type);
                    await submission.save();
                }

                // æ›´æ–°æäº¤äººçŠ¶æ€
                const submitterQuery = new AV.Query('Submitters');
                submitterQuery.equalTo('name', currentUser.name);
                const submitter = await submitterQuery.first();
                if (submitter) {
                    submitter.set('hasSubmitted', true);
                    submitter.set('submittedAt', new Date());
                    await submitter.save();
                }

                showNotification(
  `æˆåŠŸæäº¤ ${selectedFiles.length} ä¸ªæ–‡ä»¶ï¼\næ„Ÿè°¢ ${currentUser.name} å¯¹æœ¬æ¬¡æ•°æ®æ”¶é›†å·¥ä½œçš„æ”¯æŒä¸è´¡çŒ®ï¼ŒæœŸå¾…ä¸‹æ¬¡å†ä¼šã€‚`,
  'success'
);

                selectedFiles = [];
                displaySelectedFiles();
                fileInput.value = '';
                document.getElementById('submitFilesBtn').disabled = true;
                loadVisitorFiles();
                updateLimitInfo();
            } catch (error) {
                showNotification('æäº¤å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                hideLoading(btn, 'æäº¤æ–‡ä»¶');
            }
        }

        // ==================== æˆ¿ä¸»åŠŸèƒ½ ====================
        async function loadHostData() {
            await Promise.all([
                updateStats(),
                loadSubmitters(),
                loadFiles(),
                loadSettings()
            ]);
        }

        async function updateStats() {
            try {
                const submitterQuery = new AV.Query('Submitters');
                const submitters = await submitterQuery.find();
                document.getElementById('totalSubmitters').textContent = submitters.length;

                const submitted = submitters.filter(s => s.get('hasSubmitted')).length;
                document.getElementById('submittedCount').textContent = submitted;
                document.getElementById('pendingCount').textContent = submitters.length - submitted;

                const fileQuery = new AV.Query('Submissions');
                const files = await fileQuery.find();
                document.getElementById('totalFiles').textContent = files.length;
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        async function loadSubmitters() {
            const container = document.getElementById('submittersList');
            try {
                const query = new AV.Query('Submitters');
                const submitters = await query.find();
                submittersCache = submitters;

                // â­ å·²æäº¤çš„æ’å‰é¢ï¼Œæœªæäº¤çš„æ’åé¢
submitters.sort((a, b) => {
  const aSubmitted = a.get('hasSubmitted') ? 1 : 0;
  const bSubmitted = b.get('hasSubmitted') ? 1 : 0;
  return bSubmitted - aSubmitted;
});


                if (submitters.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div>æš‚æ— æäº¤äººï¼Œè¯·æ·»åŠ æˆ–å¯¼å…¥åå•</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                submitters.forEach(submitter => {
                    const item = document.createElement('div');
                    item.className = 'list-item';

                    const name = submitter.get('name');
                    const hasSubmitted = submitter.get('hasSubmitted');
                    const submittedAt = submitter.get('submittedAt');

                   item.innerHTML = `
  <div class="item-info">
    <div class="item-name">${name}</div>
    <div class="item-meta">
      ${hasSubmitted ? `å·²æäº¤äº ${formatDate(submittedAt)}` : 'å¾…æäº¤'}
    </div>
  </div>

  <div class="item-status ${hasSubmitted ? 'status-submitted' : 'status-pending'}">
    ${hasSubmitted ? 'å·²æäº¤' : 'å¾…æäº¤'}
  </div>

  <div class="item-actions">
    <button class="btn btn-success btn-small"
      onclick="exportUserFiles('${name}')">ğŸ“¦ å¯¼å‡º</button>

    <button class="btn btn-warning btn-small"
      onclick="deleteUserSubmissions('${name}')">ğŸ—‘ æ–‡ä»¶</button>

    <button class="btn btn-danger btn-small"
  onclick="deleteSubmitter('${submitter.id}', '${name}')">âŒ äººå‘˜</button>

  </div>
`;

                    container.appendChild(item);
                });
            } catch (error) {
                container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥ï¼š' + error.message + '</div>';
            }
        }

        async function loadFiles() {
            const container = document.getElementById('filesList');
            try {
                const query = new AV.Query('Submissions');
                query.include('file');
                const files = await query.find();
                submissionsCache = files;

                if (files.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“„</div>
                            <div>æš‚æ— æ–‡ä»¶æäº¤</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                files.forEach(submission => {
                    const file = submission.get('file');
                    const submitter = submission.get('submitter');
                    const item = document.createElement('div');
                    item.className = 'list-item';

                    item.innerHTML = `
                        <div class="item-info">
                            <div class="item-name">${getFileIcon(file.name)} ${file.name}</div>
                            <div class="item-meta">æäº¤äººï¼š${submitter} | ${formatDate(submission.createdAt)}</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-primary btn-small" onclick="previewFile('${submission.id}')">é¢„è§ˆ</button>
                            <button class="btn btn-success btn-small" onclick="exportSingleFile('${submission.id}')">å¯¼å‡º</button>
                            <button class="btn btn-danger btn-small" onclick="deleteSubmission('${submission.id}')">åˆ é™¤</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥ï¼š' + error.message + '</div>';
            }
        }

        async function loadSettings() {
            try {
                const query = new AV.Query('CollectSettings');
                const settings = await query.first();

                if (settings) {
                    collectionStatus = settings.get('status') || 'paused';
                    fileLimit = settings.get('fileLimit') || 3;
                    document.getElementById('fileLimit').value = fileLimit;
                }

                updateHeaderStatus();
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
            }
        }

        function updateHeaderStatus() {
            const statusDiv = document.getElementById('headerStatus');
            const statusMap = {
                'running': 'ğŸŸ¢ è¿è¡Œä¸­',
                'paused': 'ğŸŸ¡ å·²æš‚åœ',
                'ended': 'ğŸ”´ å·²ç»“æŸ'
            };

            if (currentUser) {
                statusDiv.innerHTML = `<span class="status-badge status-${collectionStatus}">${statusMap[collectionStatus]}</span>`;
            } else {
                statusDiv.innerHTML = '';
            }
        }

        function checkCollectionStatus() {
            const interval = setInterval(async () => {
                if (!currentUser) {
                    clearInterval(interval);
                    return;
                }

                try {
                    const query = new AV.Query('CollectSettings');
                    const settings = await query.first();
                    if (settings) {
                        const newStatus = settings.get('status');
                        if (newStatus !== collectionStatus) {
                            collectionStatus = newStatus;
                            updateHeaderStatus();
                            if (currentUser.role === 'visitor') {
                                showNotification(`æ”¶é›†çŠ¶æ€æ›´æ–°ï¼š${newStatus === 'running' ? 'å·²å¯åŠ¨' : newStatus === 'paused' ? 'å·²æš‚åœ' : 'å·²ç»“æŸ'}`, 'info');
                                if (newStatus !== 'running') {
                                    document.getElementById('uploadArea').style.opacity = '0.5';
                                    document.getElementById('uploadArea').style.pointerEvents = 'none';
                                } else {
                                    document.getElementById('uploadArea').style.opacity = '1';
                                    document.getElementById('uploadArea').style.pointerEvents = 'auto';
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                }
            }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // ==================== æ”¶é›†æ§åˆ¶ ====================
        async function updateCollectionStatus(status) {
            try {
                let settings = await new AV.Query('CollectSettings').first();
                if (!settings) {
                    settings = new CollectSettings();




                }
                settings.set('status', status);
                await settings.save();

                collectionStatus = status;
                updateHeaderStatus();
                showNotification(`æ”¶é›†çŠ¶æ€å·²æ›´æ–°ä¸ºï¼š${status === 'running' ? 'å¯åŠ¨' : status === 'paused' ? 'æš‚åœ' : 'ç»“æŸ'}`, 'success');
            } catch (error) {
                showNotification('æ›´æ–°çŠ¶æ€å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        async function updateFileLimit() {
            const limit = parseInt(document.getElementById('fileLimit').value);
            if (!limit || limit < 1) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼', 'error');
                return;
            }

            try {
                let settings = await new AV.Query('CollectSettings').first();
                if (!settings) {
                    settings = new CollectSettings();


                }


                settings.set('fileLimit', limit);
                await settings.save();

                fileLimit = limit;
                showNotification(`æ–‡ä»¶æ•°é‡é™åˆ¶å·²æ›´æ–°ä¸ºï¼š${limit}`, 'success');
            } catch (error) {
                showNotification('æ›´æ–°é™åˆ¶å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== æäº¤äººç®¡ç† ====================
        function showAddSubmitterModal() {
            document.getElementById('addSubmitterModal').classList.add('active');
            document.getElementById('newSubmitterName').value = '';
            document.getElementById('newSubmitterName').focus();
        }

        async function addSubmitter() {
            const name = document.getElementById('newSubmitterName').value.trim();
            if (!name) {
                showNotification('è¯·è¾“å…¥å§“åï¼', 'error');
                return;
            }

            try {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const query = new AV.Query('Submitters');
                query.equalTo('name', name);
                const existing = await query.first();

                if (existing) {
                    showNotification('è¯¥äººå‘˜å·²å­˜åœ¨ï¼', 'error');
                    return;
                }

                const submitter = new Submitters();



                submitter.set('name', name);
                submitter.set('hasSubmitted', false);
                await submitter.save();

                showNotification(`æ·»åŠ æˆåŠŸï¼š${name}`, 'success');
                closeModal('addSubmitterModal');
                loadSubmitters();
                updateStats();
            } catch (error) {
                showNotification('æ·»åŠ å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

       async function deleteSubmitter(id, name) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${name} å—ï¼Ÿ`)) return;

    try {
        // 1ï¸âƒ£ åˆ é™¤æäº¤äºº
        const submitter = AV.Object.createWithoutData('Submitters', id);
        await submitter.destroy();

        // 2ï¸âƒ£ åˆ é™¤è¯¥äººçš„æ‰€æœ‰æ–‡ä»¶
        const query = new AV.Query('Submissions');
        query.equalTo('submitter', name);
        query.limit(1000);
        const submissions = await query.find();

        for (const sub of submissions) {
            const file = sub.get('file');
            if (file) await file.destroy();
            await sub.destroy();
        }

        showNotification(`å·²åˆ é™¤ ${name} åŠå…¶æ‰€æœ‰æäº¤`, 'success');
        loadSubmitters();
        loadFiles();
        updateStats();
    } catch (error) {
        showNotification('åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
    }
}

        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
            tempImportData = [];
            document.getElementById('importFile').value = '';
            document.getElementById('importPreview').innerHTML = '';
        }

       function handleImportFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const ext = file.name.split('.').pop().toLowerCase();

    // ğŸ‘‰ Excel æ–‡ä»¶
    if (ext === 'xls' || ext === 'xlsx') {
        const reader = new FileReader();
        reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            const names = rows
                .flat()
                .map(v => String(v || '').trim())
                .filter(v => v);

            tempImportData = names;
            document.getElementById('importPreview').innerHTML =
                `<strong>é¢„è§ˆï¼ˆ${names.length}äººï¼‰ï¼š</strong><br>` +
                names.slice(0, 10).join(', ') +
                (names.length > 10 ? '...' : '');
        };
        reader.readAsArrayBuffer(file);
        return;
    }

    // ğŸ‘‰ CSV / TXTï¼ˆåŸé€»è¾‘ï¼‰
    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        const names = content.split('\n')
            .map(name => name.trim())
            .filter(name => name.length > 0);

        tempImportData = names;
        document.getElementById('importPreview').innerHTML =
            `<strong>é¢„è§ˆï¼ˆ${names.length}äººï¼‰ï¼š</strong><br>` +
            names.slice(0, 10).join(', ') +
            (names.length > 10 ? '...' : '');
    };
    reader.readAsText(file);
}


        async function confirmImport() {
            if (tempImportData.length === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼', 'error');
                return;
            }

            let successCount = 0;
            let failCount = 0;

            for (const name of tempImportData) {
                try {
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    const query = new AV.Query('Submitters');
                    query.equalTo('name', name);
                    const existing = await query.first();

                    if (!existing) {
                        const submitter = new Submitters();



                        submitter.set('name', name);
                        submitter.set('hasSubmitted', false);
                        await submitter.save();
                        successCount++;
                    } else {
                        failCount++; // å·²å­˜åœ¨
                    }
                } catch (error) {
                    failCount++;
                }
            }

            showNotification(`å¯¼å…¥å®Œæˆï¼šæˆåŠŸ ${successCount} äººï¼Œè·³è¿‡ ${failCount} äºº`, 'success');
            closeModal('importModal');
            loadSubmitters();
            updateStats();
        }

        async function clearSubmitters() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æäº¤äººå—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®ï¼')) return;
            if (!confirm('æœ€åç¡®è®¤ï¼šæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                // åˆ é™¤æ‰€æœ‰æäº¤äºº
                const submitterQuery = new AV.Query('Submitters');
                const submitters = await submitterQuery.find();
                for (const s of submitters) {
                    await s.destroy();
                }

                // åˆ é™¤æ‰€æœ‰æäº¤æ–‡ä»¶
                const submissionQuery = new AV.Query('Submissions');
                const submissions = await submissionQuery.find();
                for (const sub of submissions) {
                    const file = sub.get('file');
                    if (file) await file.destroy();
                    await sub.destroy();
                }

                showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼', 'success');
                loadSubmitters();
                loadFiles();
                updateStats();
            } catch (error) {
                showNotification('æ¸…ç©ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== æ–‡ä»¶ç®¡ç† ====================
        async function previewFile(id) {
            try {
                const query = new AV.Query('Submissions');
                query.include('file');
                const submission = await query.get(id);
                const file = submission.get('file');

                const modal = document.getElementById('filePreviewModal');
                const body = document.getElementById('modalBody');
                const actions = document.getElementById('modalActions');

                let content = '';
                if (file.get('mime-type')?.startsWith('image/') ||
                    ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(file.name.split('.').pop().toLowerCase())) {
                    content = `<img src="${file.url()}" alt="${file.name}">`;
                } else {
                    content = `
                        <div class="file-icon" style="font-size: 5rem; height: 200px;">
                            ${getFileIcon(file.name)}
                        </div>
                        <div style="text-align: center; margin-top: 10px;">æ— æ³•é¢„è§ˆæ­¤æ–‡ä»¶ç±»å‹</div>
                    `;
                }

                body.innerHTML = `
                    ${content}
                    <div class="file-info">
                        <div><strong>æ–‡ä»¶åï¼š</strong>${file.name}</div>
                        <div><strong>æäº¤äººï¼š</strong>${submission.get('submitter')}</div>
                        <div><strong>æäº¤æ—¶é—´ï¼š</strong>${formatDate(submission.createdAt)}</div>
                        <div><strong>æ–‡ä»¶å¤§å°ï¼š</strong>${(file.size() / 1024).toFixed(2)} KB</div>
                    </div>
                `;

                actions.innerHTML = `
                    <button class="btn btn-success" onclick="exportSingleFile('${id}')">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</button>
                    <button class="btn btn-secondary" onclick="closeModal('filePreviewModal')">å…³é—­</button>
                `;

                modal.classList.add('active');
            } catch (error) {
                showNotification('é¢„è§ˆå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        async function exportSingleFile(id) {
            try {
                const query = new AV.Query('Submissions');
                query.include('file');
                const submission = await query.get(id);
                const file = submission.get('file');

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.href = file.url();
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification(`å¼€å§‹ä¸‹è½½ï¼š${file.name}`, 'success');
            } catch (error) {
                showNotification('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }
async function exportAllFiles() {
  try {
    const query = new AV.Query('Submissions');
    query.limit(1000);
    const list = await query.find();

    let allFiles = [];

    list.forEach(item => {
      item.attributes && Object.values(item.attributes).forEach(val => {
        // å•æ–‡ä»¶
        if (val instanceof AV.File) {
          allFiles.push(val);
        }
        // å¤šæ–‡ä»¶æ•°ç»„
        if (Array.isArray(val)) {
          val.forEach(v => {
            if (v instanceof AV.File) {
              allFiles.push(v);
            }
          });
        }
      });
    });

    if (allFiles.length === 0) {
      showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„æ–‡ä»¶ï¼ˆå­—æ®µä¸­æœªå‘ç° AV.Fileï¼‰', 'warning');
      return;
    }

    await downloadFilesAsZip(allFiles, 'å…¨éƒ¨æäº¤æ–‡ä»¶.zip');
    showNotification('ZIP å·²å¼€å§‹ä¸‹è½½', 'success');

  } catch (error) {
    showNotification('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
  }
}



        async function deleteSubmission(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) return;

            try {
                const submission = AV.Object.createWithoutData('Submissions', id);
                const file = submission.get('file');

                await submission.destroy();
                if (file) await file.destroy();

                showNotification('æ–‡ä»¶å·²åˆ é™¤', 'success');
                loadFiles();
                updateStats();
            } catch (error) {
                showNotification('åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        async function clearAllFiles() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æäº¤çš„æ–‡ä»¶å—ï¼Ÿ')) return;
            if (!confirm('æœ€åç¡®è®¤ï¼šæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                const query = new AV.Query('Submissions');
                const submissions = await query.find();

                for (const sub of submissions) {
                    const file = sub.get('file');
                    if (file) await file.destroy();
                    await sub.destroy();
                }

                // é‡ç½®æäº¤äººçŠ¶æ€
                const submitterQuery = new AV.Query('Submitters');
                const submitters = await submitterQuery.find();
                for (const s of submitters) {
                    s.set('hasSubmitted', false);
                    await s.save();
                }

                showNotification('æ‰€æœ‰æ–‡ä»¶å·²æ¸…ç©ºï¼', 'success');
                loadFiles();
                loadSubmitters();
                updateStats();
            } catch (error) {
                showNotification('æ¸…ç©ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== é«˜çº§è®¾ç½® ====================
        async function resetCollection() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ”¶é›†å†…å®¹å—ï¼Ÿï¼ˆä¿ç•™åå•ï¼‰')) return;

            try {
                // åˆ é™¤æ‰€æœ‰æ–‡ä»¶
                const query = new AV.Query('Submissions');
                const submissions = await query.find();

                for (const sub of submissions) {
                    const file = sub.get('file');
                    if (file) await file.destroy();
                    await sub.destroy();
                }

                // é‡ç½®æäº¤äººçŠ¶æ€
                const submitterQuery = new AV.Query('Submitters');
                const submitters = await submitterQuery.find();
                for (const s of submitters) {
                    s.set('hasSubmitted', false);
                    s.unset('submittedAt');
                    await s.save();
                }

                showNotification('æ”¶é›†å†…å®¹å·²é‡ç½®ï¼', 'success');
                loadHostData();
            } catch (error) {
                showNotification('é‡ç½®å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        async function resetAll() {
            if (!confirm('ç¡®å®šè¦é‡ç½®å…¨éƒ¨å—ï¼Ÿï¼ˆåŒ…æ‹¬æ‰€æœ‰åå•å’Œæ–‡ä»¶ï¼‰')) return;
            if (!confirm('æœ€åç¡®è®¤ï¼šæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                // åˆ é™¤æ‰€æœ‰æäº¤äºº
                const submitterQuery = new AV.Query('Submitters');
                const submitters = await submitterQuery.find();
                for (const s of submitters) {
                    await s.destroy();
                }

                // åˆ é™¤æ‰€æœ‰æäº¤æ–‡ä»¶
                const submissionQuery = new AV.Query('Submissions');
                const submissions = await submissionQuery.find();
                for (const sub of submissions) {
                    const file = sub.get('file');
                    if (file) await file.destroy();
                    await sub.destroy();
                }

                // é‡ç½®è®¾ç½®
                const settingsQuery = new AV.Query('CollectSettings');
                const settings = await settingsQuery.first();
                if (settings) {
                    settings.set('status', 'paused');
                    settings.set('fileLimit', 3);
                    await settings.save();
                }

                showNotification('ç³»ç»Ÿå·²å®Œå…¨é‡ç½®ï¼', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } catch (error) {
                showNotification('é‡ç½®å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== é€šç”¨UIå‡½æ•° ====================
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­æ ‡ç­¾
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'submitters') loadSubmitters();
            if (tabName === 'files') loadFiles();
            if (tabName === 'settings') updateSystemInfo();
        }

        function updateSystemInfo() {
            const info = document.getElementById('systemInfo');
            info.innerHTML = `
                <div><strong>å½“å‰ç‰ˆæœ¬ï¼š</strong> v1.0.0</div>
                <div><strong>å­˜å‚¨æœåŠ¡ï¼š</strong> LeanCloud</div>
                <div><strong>å½“å‰çŠ¶æ€ï¼š</strong> ${collectionStatus}</div>
                <div><strong>æ–‡ä»¶é™åˆ¶ï¼š</strong> ${fileLimit} ä¸ª/äºº</div>
                <div><strong>æ›´æ–°æ—¶é—´ï¼š</strong> ${formatDate(new Date())}</div>
            `;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.querySelectorAll('.file-preview-modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // ==================== åˆå§‹åŒ– ====================
        window.addEventListener('load', () => {
            // æ£€æŸ¥æ˜¯å¦é…ç½®
            if (LEAN_CONFIG.appId === 'YOUR_APP_ID' || !LEAN_CONFIG.appId) {
                showNotification('âš ï¸ è¯·å…ˆé…ç½®LeanCloudä¿¡æ¯ï¼', 'error');
            }
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // ESCå…³é—­æ¨¡æ€æ¡†
            if (e.key === 'Escape') {
                document.querySelectorAll('.file-preview-modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // ================= ZIP ä¸‹è½½ =================
async function downloadFilesAsZip(files, zipName = 'files.zip') {
  if (!files || files.length === 0) {
    showNotification('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶', 'warning');
    return;
  }

  const zip = new JSZip();

  for (let i = 0; i < files.length; i++) {
    const file = files[i];

    if (!file || !file.url) continue;

    const url = file.url();
    const filename = file.get('name') || `file_${i + 1}`;

    const response = await fetch(url);
    const blob = await response.blob();

    zip.file(filename, blob);
  }

  const zipBlob = await zip.generateAsync({ type: 'blob' });

  const a = document.createElement('a');
  a.href = URL.createObjectURL(zipBlob);
  a.download = zipName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(a.href);
}

async function exportUserFiles(userName) {
  try {
    const query = new AV.Query('Submissions');
    query.equalTo('submitter', userName);
    query.limit(1000);

    const list = await query.find();
    let files = [];

    list.forEach(item => {
      Object.values(item.attributes).forEach(val => {
        if (val instanceof AV.File) files.push(val);
        if (Array.isArray(val)) {
          val.forEach(v => v instanceof AV.File && files.push(v));
        }
      });
    });

    if (files.length === 0) {
      showNotification('è¯¥ç”¨æˆ·æ²¡æœ‰æ–‡ä»¶å¯å¯¼å‡º', 'warning');
      return;
    }

    await downloadFilesAsZip(files, `${userName}_æ–‡ä»¶.zip`);
    showNotification(`å·²å¯¼å‡º ${userName} çš„æ–‡ä»¶`, 'success');

  } catch (err) {
    showNotification('å¯¼å‡ºå¤±è´¥ï¼š' + err.message, 'error');
  }
}

async function deleteUserSubmissions(userName) {
  if (!confirm(`ç¡®å®šåˆ é™¤ ${userName} çš„æ‰€æœ‰æäº¤æ–‡ä»¶å—ï¼Ÿ`)) return;

  try {
    // 1ï¸âƒ£ åˆ é™¤ Submissionsï¼ˆæ–‡ä»¶è®°å½•ï¼‰
    const subQuery = new AV.Query('Submissions');
    subQuery.equalTo('submitter', userName);
    subQuery.limit(1000);

    const submissions = await subQuery.find();

    for (const item of submissions) {
      await item.destroy();
    }

    // 2ï¸âƒ£ åŒæ­¥æ›´æ–° Submitters çŠ¶æ€ï¼ˆå…³é”®ï¼ï¼ï¼ï¼‰
    const submitterQuery = new AV.Query('Submitters');
    submitterQuery.equalTo('name', userName);
    const submitter = await submitterQuery.first();

    if (submitter) {
      submitter.set('hasSubmitted', false);
      submitter.set('submittedAt', null);
      await submitter.save();
    }

    // 3ï¸âƒ£ åˆ·æ–°ç•Œé¢
    showNotification(`${userName} çš„æ–‡ä»¶å·²åˆ é™¤ï¼ŒçŠ¶æ€å·²é‡ç½®`, 'success');
    loadFiles();
    loadSubmitters();
    updateStats();

  } catch (err) {
    showNotification('åˆ é™¤å¤±è´¥ï¼š' + err.message, 'error');
  }
}


    </script>
</body>
</html>

