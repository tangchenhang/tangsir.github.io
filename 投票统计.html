<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¥¨ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fb 100%);
            min-height: 100vh;
            padding: 20px;
            background-attachment: fixed;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e8f4f8;
        }
        #initTab {
            text-align: center;
            padding: 60px 30px;
            background: linear-gradient(180deg, #f8fcff 0%, #ffffff 100%);
            border-radius: 12px;
        }
        #initTab h2 {
            font-size: 28px;
            color: #2d3748;
            margin-bottom: 40px;
            font-weight: 600;
            position: relative;
            display: inline-block;
        }
        #initTab h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, #409eff, #67c23a);
            border-radius: 3px;
        }
        #initTab .btn-group {
            justify-content: center;
            gap: 20px;
        }
        #initTab button {
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 8px;
            background: linear-gradient(90deg, #409eff, #5cadff);
            box-shadow: 0 4px 10px rgba(64, 158, 255, 0.3);
        }
        #initTab button:hover {
            background: linear-gradient(90deg, #337ecc, #409eff);
            transform: translateY(-2px);
            transition: all 0.2s;
        }

        .tab {
            display: none;
        }
        .tab.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-group {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #409eff;
            color: white;
            font-size: 14px;
            transition: all 0.2s;
        }
        button:hover {
            background-color: #337ecc;
            transform: translateY(-1px);
        }
        button.danger {
            background-color: #f56c6c;
        }
        button.danger:hover {
            background-color: #e45656;
        }
        button.secondary {
            background-color: #909399;
        }
        button.secondary:hover {
            background-color: #73767a;
        }
        button.import-btn {
            background-color: #67c23a;
        }
        button.import-btn:hover {
            background-color: #52b32d;
        }
        button.end-btn {
            background-color: #ff4d4f;
        }
        button.end-btn:hover {
            background-color: #ff2b2b;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px 14px;
            margin: 8px 0;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.2s;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #409eff;
            box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1);
        }
        .form-item {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .list-box {
            border: 1px solid #e8e8e8;
            padding: 15px;
            border-radius: 6px;
            min-height: 80px;
            margin: 10px 0;
            background: #fafafa;
        }
        .status-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status-lock {
            background-color: #fdf2e9;
            color: #e67700;
        }
        .status-unlock {
            background-color: #f0f9ff;
            color: #409eff;
        }
        .status-pause {
            background-color: #fef0f0;
            color: #f56c6c;
        }
        .status-normal {
            background-color: #f0f9ff;
            color: #67c23a;
        }
        .status-ended {
            background-color: #fff1f0;
            color: #ff4d4f;
        }
        .result-item {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        h2, h3 {
            margin-bottom: 20px;
            color: #2d3748;
        }
        h3 {
            font-size: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .tip {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }
        .import-box {
            margin: 10px 0;
            padding: 15px;
            border: 2px dashed #e8e8e8;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .import-box:hover {
            border-color: #409eff;
            background: #f8fcff;
        }
        .import-box input {
            display: none;
        }
        .import-text {
            color: #666;
            font-size: 14px;
        }
        .vote-count-setting {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .vote-count-setting input {
            width: 80px;
        }
        /* ç¦ç”¨çŠ¶æ€æ ·å¼ */
        .disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
        }
        .disabled:hover {
            background-color: #409eff !important;
            transform: none !important;
        }

        /* === åå•æ§åˆ¶åŒºæŒ‰é’®å¾®è°ƒ === */
#hostManageTab .form-item button {
    padding: 9px 18px;
    border-radius: 10px;
    font-weight: 500;
}

/* é”å®šåå•ï¼šä¸»æ“ä½œ */
#lockBtn {
    background: linear-gradient(135deg, #409eff, #66b1ff);
    box-shadow: 0 4px 12px rgba(64, 158, 255, 0.25);
}
#lockBtn:hover {
    background: linear-gradient(135deg, #337ecc, #409eff);
}

/* ä¸€é”®æ¸…ç©ºåå•ï¼šå±é™©ä½†å…‹åˆ¶ */
button.danger {
    background: linear-gradient(135deg, #ff7875, #ff4d4f);
    box-shadow: 0 4px 10px rgba(255, 77, 79, 0.25);
}
button.danger:hover {
    background: linear-gradient(135deg, #ff4d4f, #d9363e);
}

/* çŠ¶æ€æ ‡ç­¾ï¼šæ›´åƒâ€œæç¤ºä¿¡æ¯â€ï¼Œä¸å†åƒæŒ‰é’® */
.status-tag {
    margin-left: auto;              /* ğŸ‘‰ è‡ªåŠ¨æ¨åˆ°æœ€å³ä¾§ */
    padding: 6px 14px;
    border-radius: 999px;            /* èƒ¶å›Šå½¢ */
    font-size: 13px;
    font-weight: 500;
}

/* æœªé”å®šçŠ¶æ€ */
.status-unlock {
    background: #ecf5ff;
    color: #409eff;
    border: 1px solid #d9ecff;
}

/* å·²é”å®šçŠ¶æ€ */
.status-lock {
    background: #fff7e6;
    color: #d48806;
    border: 1px solid #ffe7ba;
}

#hostManageTab .form-item > div {
    width: 100%;
}

/* åå•æ“ä½œè¡Œï¼šæŒ‰é’®å’ŒçŠ¶æ€å½»åº•åˆ†ç¦» */
#hostManageTab .form-item > div {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* ä¸¤ä¸ªæŒ‰é’®ä¸€ä¸ªæŒ‰é’®ç»„ */
#lockBtn,
#hostManageTab button.danger {
    flex-shrink: 0;
}

/* çŠ¶æ€æ ‡ç­¾æ°¸è¿œé å³ï¼Œä¸ç›–æŒ‰é’® */
#listLockStatus {
    margin-left: auto;
    pointer-events: none;   /* å…³é”®ï¼šä¸æŠ¢ç‚¹å‡» */
}

    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- 1. åˆå§‹é€‰æ‹©é¡µ -->
        <div id="initTab" class="tab active">
            <h2>æŠ•ç¥¨ç®¡ç†ç³»ç»Ÿ</h2>
            <div class="btn-group">
                <button onclick="switchTab('hostLoginTab')">æˆ¿ä¸»ç™»å½•</button>
                <button onclick="switchTab('visitorLoginTab')">è®¿å®¢æŠ•ç¥¨</button>
            </div>
        </div>

        <!-- 2. æˆ¿ä¸»ç™»å½•é¡µ -->
        <div id="hostLoginTab" class="tab">
            <h2>æˆ¿ä¸»ç™»å½•</h2>
            <div class="form-item">
                <label>æˆ¿ä¸»å¯†ç </label>
                <input type="password" id="hostPwd" placeholder="è¯·è¾“å…¥æˆ¿ä¸»å¯†ç ">
            </div>
            <div class="btn-group">
                <button onclick="hostLogin()">ç™»å½•</button>
                <button class="secondary" onclick="switchTab('initTab')">è¿”å›</button>
            </div>
        </div>

        <!-- 3. æˆ¿ä¸»ç®¡ç†é¡µï¼ˆæ–°å¢ä¿®æ”¹æƒé™+ç»ˆæ­¢æŒ‰é’®ï¼‰ -->
        <div id="hostManageTab" class="tab">
            <h2>æˆ¿ä¸»ç®¡ç†ä¸­å¿ƒ</h2>
            
            <!-- æŠ•ç¥¨åå•ç®¡ç† -->
            <div class="form-item">
                <h3>æŠ•ç¥¨äººåå•ç®¡ç†</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="addVoterInput" placeholder="è¾“å…¥è¦æ·»åŠ çš„æŠ•ç¥¨äººå§“å" style="flex: 1;">
                    <button onclick="addVoter()">æ·»åŠ </button>
                    
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    
                   
                    <button class="import-btn" onclick="document.getElementById('importFile').click()">å¯¼å…¥åå•</button>
                </div>
            
                <div class="import-box" onclick="document.getElementById('importFile').click()">
                    <input type="file" id="importFile" accept=".xlsx,.xls,.txt" onchange="importVoterList(event)">
                    <div class="import-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„å¯¼å…¥åå•ï¼ˆæ”¯æŒExcel/Word/çº¯æ–‡æœ¬ï¼‰</div>
                    <div class="tip">æç¤ºï¼šExcel/Wordè¯·ç¡®ä¿å§“ååœ¨ç¬¬ä¸€åˆ—ï¼Œæ¯è¡Œä¸€ä¸ªå§“åï¼›çº¯æ–‡æœ¬æ¯è¡Œä¸€ä¸ªå§“å</div>
                </div>
                <label>å½“å‰æŠ•ç¥¨äººåå•ï¼ˆæ¯è¡Œä¸€ä¸ªå§“åï¼‰ï¼š</label>
                <textarea id="voterListText" rows="6" placeholder="ä¾‹å¦‚ï¼š&#10;å¼ ä¸‰&#10;æå››&#10;ç‹äº”"></textarea>
                <div style="display: flex; align-items: center; margin: 10px 0;">
                    <button onclick="lockVoterList()" id="lockBtn">é”å®šåå•</button>
                    <button class="danger" onclick="clearVoterList()">ä¸€é”®æ¸…ç©ºåå•</button>

                    <span id="listLockStatus" class="status-tag status-unlock">åå•æœªé”å®š</span>
                </div>
            </div>

            <!-- æŠ•ç¥¨é€‰é¡¹è®¾ç½® -->
            <div class="form-item">
                <h3>æŠ•ç¥¨é€‰é¡¹è®¾ç½®</h3>
                <label>æŠ•ç¥¨é€‰é¡¹ï¼ˆæ¯è¡Œä¸€ä¸ªé€‰é¡¹ï¼‰ï¼š</label>
                <textarea id="voteOptionsText" rows="4" placeholder="ä¾‹å¦‚ï¼š&#10;é€‰é¡¹A&#10;é€‰é¡¹B&#10;é€‰é¡¹C"></textarea>
                <div class="vote-count-setting" style="margin: 10px 0;">
                    <label style="margin: 0;">æœ€å¤šå¯æŠ•é€‰é¡¹æ•°ï¼š</label>
                    <input type="number" id="voteMaxCount" min="1" value="1" placeholder="è¯·è¾“å…¥æ•°å­—">
                    <button onclick="saveVoteCount()">ä¿å­˜æ•°é‡</button>
                    <div class="tip" style="flex: 1; margin-left: 10px;">è®¾ç½®ä¸º1åˆ™ä¸ºå•é€‰ï¼Œå¤§äº1åˆ™ä¸ºå¤šé€‰ï¼ˆå¦‚è®¾ç½®2å¯æŠ•2ä¸ªé€‰é¡¹ï¼‰</div>
                </div>
                <button onclick="saveVoteOptions()">ä¿å­˜é€‰é¡¹</button>
            </div>

            <!-- æŠ•ç¥¨çŠ¶æ€æ§åˆ¶ï¼ˆæ–°å¢ä¿®æ”¹æƒé™+ç»ˆæ­¢æŒ‰é’®ï¼‰ -->
            <div class="form-item">
                <h3>æŠ•ç¥¨çŠ¶æ€æ§åˆ¶</h3>
                <!-- æ–°å¢ï¼šä¿®æ”¹æƒé™å¼€å…³ -->
                <div style="margin: 10px 0;">
                    <label>
                        <input type="checkbox" id="allowEditCheck"> å…è®¸è®¿å®¢ä¿®æ”¹å·²æäº¤çš„æŠ•ç¥¨ç»“æœ
                    </label>
                    <div class="tip">å–æ¶ˆå‹¾é€‰åï¼Œè®¿å®¢æäº¤æŠ•ç¥¨åæ— æ³•å†ä¿®æ”¹</div>
                </div>
                <!-- æš‚åœ/æ¢å¤ + ç»ˆæ­¢æŒ‰é’® -->
                <div style="display: flex; align-items: center; margin: 10px 0; gap: 15px;">
                    <button onclick="toggleVotePause()" id="pauseBtn">æš‚åœæŠ•ç¥¨</button>
                    <button class="end-btn" onclick="toggleVoteEnd()" id="endBtn">ç»ˆæ­¢æŠ•ç¥¨</button>
                    <span id="voteStatus" class="status-tag status-normal">æŠ•ç¥¨ä¸­</span>
                </div>
                <button class="danger" onclick="resetVote()">é‡ç½®æ‰€æœ‰æŠ•ç¥¨æ•°æ®</button>
            </div>

            <!-- ç»“æœå…¬å¼€æ§åˆ¶ -->
            <div class="form-item">
                <h3>ç»“æœå…¬å¼€è®¾ç½®</h3>
                <div style="margin: 10px 0;">
                    <label>
                        <input type="checkbox" id="resultPublicCheck"> å…¬å¼€æŠ•ç¥¨æ€»ç»“æœ
                    </label>
                </div>
                <div style="margin: 10px 0;">
                    <label>
                        <input type="checkbox" id="detailPublicCheck"> å…¬å¼€æ¯ä¸ªäººçš„æŠ•ç¥¨è¯¦æƒ…
                    </label>
                </div>
                <button onclick="savePublicSetting()">ä¿å­˜è®¾ç½®</button>
            </div>

            <!-- æŸ¥çœ‹ç»“æœ -->
            <div class="form-item">
                <h3>æŠ•ç¥¨ç»“æœï¼ˆæˆ¿ä¸»æŸ¥çœ‹ï¼‰</h3>
                <button onclick="showHostResult()">æŸ¥çœ‹å®Œæ•´ç»“æœ</button>
                <div id="hostResultBox" class="list-box"></div>
            </div>

            <div class="btn-group">
                <button class="secondary" onclick="switchTab('initTab')">é€€å‡º</button>
            </div>
        </div>

        <!-- 4. è®¿å®¢ç™»å½•é¡µ -->
        <div id="visitorLoginTab" class="tab">
            <h2>è®¿å®¢æŠ•ç¥¨éªŒè¯</h2>
            <div class="form-item">
                <label>è¯·è¾“å…¥æ‚¨çš„å§“å</label>
                <input type="text" id="visitorName" placeholder="è¾“å…¥å§“åéªŒè¯èº«ä»½">
            </div>
            <div class="btn-group">
                <button onclick="visitorVerify()">éªŒè¯å¹¶è¿›å…¥æŠ•ç¥¨</button>
                <button class="secondary" onclick="switchTab('initTab')">è¿”å›</button>
            </div>
            <div id="visitorVerifyTip" style="color: red; margin-top: 10px;"></div>
        </div>

        <!-- 5. è®¿å®¢æŠ•ç¥¨é¡µï¼ˆé€‚é…ä¿®æ”¹æƒé™+ç»ˆæ­¢çŠ¶æ€ï¼‰ -->
        <div id="visitorVoteTab" class="tab">
            <h2>æŠ•ç¥¨ç•Œé¢</h2>
            <div id="visitorNameTip" style="margin-bottom: 20px; font-weight: 500;"></div>
            <div id="voteOptionsBox" class="form-item"></div>
            <div class="btn-group">
                <button onclick="submitVote()" id="submitVoteBtn">æäº¤æŠ•ç¥¨</button>
                <button class="secondary" onclick="switchTab('visitorLoginTab')">è¿”å›</button>
            </div>
            <div id="voteSubmitTip" style="color: red; margin-top: 10px;"></div>
        </div>

        <!-- 6. æŠ•ç¥¨ç»“æœé¡µ -->
        <div id="resultTab" class="tab">
            <h2>æŠ•ç¥¨ç»“æœ</h2>
            <div id="publicResultBox" class="list-box"></div>
            <div class="btn-group">
                <button class="secondary" onclick="switchTab('initTab')">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†ï¼ˆæ–°å¢ä¿®æ”¹æƒé™+ç»ˆæ­¢çŠ¶æ€ï¼‰
        const STORAGE_KEY = "vote_system_data";
        let voteData = {
            hostPwd: "953191",               // æˆ¿ä¸»é»˜è®¤å¯†ç 
            voterList: [],                   // æŠ•ç¥¨äººåå•
            isListLocked: false,             // åå•æ˜¯å¦é”å®š
            voteOptions: [],                 // æŠ•ç¥¨é€‰é¡¹
            voteMaxCount: 1,                 // æœ€å¤šå¯æŠ•é€‰é¡¹æ•°
            allowVoteEdit: true,             // æ–°å¢ï¼šæ˜¯å¦å…è®¸è®¿å®¢ä¿®æ”¹å·²æŠ•ç»“æœ
            isVotePaused: false,             // æ˜¯å¦æš‚åœæŠ•ç¥¨
            isVoteEnded: false,              // æ–°å¢ï¼šæ˜¯å¦ç»ˆæ­¢æŠ•ç¥¨ï¼ˆç»ˆæ­¢åæ— æ³•æŠ•ç¥¨/ä¿®æ”¹ï¼‰
            voteRecords: {},                 // æŠ•ç¥¨è®°å½• {å§“å: [é€‰é¡¹1, é€‰é¡¹2] æˆ– é€‰é¡¹}
            isResultPublic: false,           // æ˜¯å¦å…¬å¼€æ€»ç»“æœ
            isDetailPublic: false            // æ˜¯å¦å…¬å¼€è¯¦ç»†è®°å½•
        };

        // åˆå§‹åŒ–
        function initData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) voteData = JSON.parse(saved);
            syncHostUI();
        }

        // ä¿å­˜æ•°æ®
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(voteData));
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            document.getElementById('visitorVerifyTip').textContent = '';
            document.getElementById('voteSubmitTip').textContent = '';
        }

        // ---------------------- åå•å¯¼å…¥åŠŸèƒ½ ----------------------
        function importVoterList(event) {
            if (voteData.isListLocked || voteData.isVoteEnded) {
                alert('åå•å·²é”å®šæˆ–æŠ•ç¥¨å·²ç»ˆæ­¢ï¼Œæ— æ³•å¯¼å…¥ï¼');
                event.target.value = '';
                return;
            }
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    const voterList = jsonData
                        .map(row => row[0]?.toString().trim())
                        .filter(name => name && name !== 'undefined');
                    if (voterList.length === 0) {
                        alert('æœªä»Excelä¸­è§£æåˆ°æœ‰æ•ˆå§“åï¼');
                        return;
                    }
                    voteData.voterList = voterList;
                    document.getElementById('voterListText').value = voterList.join('\n');
                    saveData();
                    alert(`æˆåŠŸå¯¼å…¥ ${voterList.length} ä¸ªæŠ•ç¥¨äººï¼`);
                    event.target.value = '';
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith('.txt')) {
                reader.onload = function(e) {
                    const text = e.target.result;
                    const voterList = text
                        .split('\n')
                        .map(name => name.trim())
                        .filter(name => name);
                    if (voterList.length === 0) {
                        alert('æœªä»æ–‡æœ¬æ–‡ä»¶ä¸­è§£æåˆ°æœ‰æ•ˆå§“åï¼');
                        return;
                    }
                    voteData.voterList = voterList;
                    document.getElementById('voterListText').value = voterList.join('\n');
                    saveData();
                    alert(`æˆåŠŸå¯¼å…¥ ${voterList.length} ä¸ªæŠ•ç¥¨äººï¼`);
                    event.target.value = '';
                };
                reader.readAsText(file, 'utf-8');
            } else if (file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                alert('Wordæ–‡ä»¶æš‚ä¸ç›´æ¥æ”¯æŒè§£æï¼Œè¯·å°†å§“åæ•´ç†åˆ°Excelæˆ–çº¯æ–‡æœ¬æ–‡ä»¶åå¯¼å…¥ï¼');
                event.target.value = '';
            }
        }

        // ---------------------- é€‰ç¥¨æ•°é‡è®¾ç½® ----------------------
        function saveVoteCount() {
            if (voteData.isVoteEnded) {
                alert('æŠ•ç¥¨å·²ç»ˆæ­¢ï¼Œæ— æ³•ä¿®æ”¹é€‰ç¥¨æ•°é‡ï¼');
                return;
            }
            const count = parseInt(document.getElementById('voteMaxCount').value);
            if (isNaN(count) || count < 1) {
                alert('è¯·è¾“å…¥å¤§äºç­‰äº1çš„æ•°å­—ï¼');
                return;
            }
            voteData.voteMaxCount = count;
            saveData();
            alert(`é€‰ç¥¨æ•°é‡è®¾ç½®æˆåŠŸï¼æœ€å¤šå¯æŠ• ${count} ä¸ªé€‰é¡¹`);
        }

        // ---------------------- æˆ¿ä¸»åŠŸèƒ½ ----------------------
        function hostLogin() {
            const pwd = document.getElementById('hostPwd').value;
            if (pwd === voteData.hostPwd) {
                switchTab('hostManageTab');
                syncHostUI();
            } else {
                alert('å¯†ç é”™è¯¯ï¼');
            }
        }

        // åŒæ­¥æˆ¿ä¸»ç•Œé¢çŠ¶æ€ï¼ˆæ–°å¢ä¿®æ”¹æƒé™+ç»ˆæ­¢çŠ¶æ€ï¼‰
        function syncHostUI() {
            // åŒæ­¥åå•
            document.getElementById('voterListText').value = voteData.voterList.join('\n');
            
            // åŒæ­¥åå•é”å®šçŠ¶æ€
            const lockBtn = document.getElementById('lockBtn');
            const lockStatus = document.getElementById('listLockStatus');
            if (voteData.isListLocked) {
                lockBtn.textContent = 'è§£é”åå•';
                lockStatus.className = 'status-tag status-lock';
                lockStatus.textContent = 'åå•å·²é”å®š';
            } else {
                lockBtn.textContent = 'é”å®šåå•';
                lockStatus.className = 'status-tag status-unlock';
                lockStatus.textContent = 'åå•æœªé”å®š';
            }
            
            // åŒæ­¥æŠ•ç¥¨é€‰é¡¹
            document.getElementById('voteOptionsText').value = voteData.voteOptions.join('\n');
            
            // åŒæ­¥é€‰ç¥¨æ•°é‡
            document.getElementById('voteMaxCount').value = voteData.voteMaxCount;
            
            // åŒæ­¥ä¿®æ”¹æƒé™å¼€å…³
            document.getElementById('allowEditCheck').checked = voteData.allowVoteEdit;
            
            // åŒæ­¥æŠ•ç¥¨çŠ¶æ€ï¼ˆæš‚åœ/ç»ˆæ­¢ï¼‰
            const pauseBtn = document.getElementById('pauseBtn');
            const endBtn = document.getElementById('endBtn');
            const voteStatus = document.getElementById('voteStatus');
            
            // ç»ˆæ­¢çŠ¶æ€ä¼˜å…ˆ
            if (voteData.isVoteEnded) {
                pauseBtn.disabled = true;
                pauseBtn.classList.add('disabled');
                endBtn.textContent = 'å·²ç»ˆæ­¢æŠ•ç¥¨ï¼ˆä¸å¯æ¢å¤ï¼‰';
                voteStatus.className = 'status-tag status-ended';
                voteStatus.textContent = 'æŠ•ç¥¨å·²ç»ˆæ­¢';
            } else {
                pauseBtn.disabled = false;
                pauseBtn.classList.remove('disabled');
                endBtn.textContent = 'ç»ˆæ­¢æŠ•ç¥¨';
                if (voteData.isVotePaused) {
                    pauseBtn.textContent = 'æ¢å¤æŠ•ç¥¨';
                    voteStatus.className = 'status-tag status-pause';
                    voteStatus.textContent = 'æŠ•ç¥¨å·²æš‚åœ';
                } else {
                    pauseBtn.textContent = 'æš‚åœæŠ•ç¥¨';
                    voteStatus.className = 'status-tag status-normal';
                    voteStatus.textContent = 'æŠ•ç¥¨ä¸­';
                }
            }
            
            // åŒæ­¥å…¬å¼€è®¾ç½®
            document.getElementById('resultPublicCheck').checked = voteData.isResultPublic;
            document.getElementById('detailPublicCheck').checked = voteData.isDetailPublic;
        }

        // æ·»åŠ æŠ•ç¥¨äºº
        function addVoter() {
            if (voteData.isListLocked || voteData.isVoteEnded) {
                alert('åå•å·²é”å®šæˆ–æŠ•ç¥¨å·²ç»ˆæ­¢ï¼Œæ— æ³•æ·»åŠ ï¼');
                return;
            }
            const name = document.getElementById('addVoterInput').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥å§“åï¼');
                return;
            }
            if (voteData.voterList.includes(name)) {
                alert('è¯¥å§“åå·²å­˜åœ¨ï¼');
                return;
            }
            voteData.voterList.push(name);
            document.getElementById('voterListText').value = voteData.voterList.join('\n');
            document.getElementById('addVoterInput').value = '';
            saveData();
            alert('æ·»åŠ æˆåŠŸï¼');
        }

        

        
        // é”å®š/è§£é”åå•
       function lockVoterList() {
    if (voteData.isVoteEnded) {
        alert('æŠ•ç¥¨å·²ç»ˆæ­¢ï¼Œæ— æ³•ä¿®æ”¹åå•é”å®šçŠ¶æ€ï¼');
        return;
    }

    // âœ… åœ¨â€œé”å®šâ€ä¹‹å‰ï¼ŒåŒæ­¥æ–‡æœ¬æ¡†å†…å®¹
    if (!voteData.isListLocked) {
        const text = document.getElementById('voterListText').value.trim();
        const newList = text
            ? text.split('\n').map(n => n.trim()).filter(n => n)
            : [];

        voteData.voterList = newList;

        // åŒæ­¥åˆ é™¤å·²ä¸å­˜åœ¨çš„æŠ•ç¥¨è®°å½•
        Object.keys(voteData.voteRecords).forEach(name => {
            if (!newList.includes(name)) {
                delete voteData.voteRecords[name];
            }
        });
    }

    voteData.isListLocked = !voteData.isListLocked;
    syncHostUI();
    saveData();

    alert(voteData.isListLocked ? 'åå•å·²é”å®šï¼' : 'åå•å·²è§£é”ï¼');
}


function clearVoterList() {
    if (voteData.isVoteEnded) {
        alert('æŠ•ç¥¨å·²ç»ˆæ­¢ï¼Œæ— æ³•æ¸…ç©ºåå•ï¼');
        return;
    }

    if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŠ•ç¥¨äººåå•å—ï¼Ÿè¯¥æ“ä½œä¼šåŒæ—¶æ¸…ç©ºå·²æäº¤çš„æŠ•ç¥¨è®°å½•ï¼')) {
        return;
    }

    voteData.voterList = [];
    voteData.voteRecords = {};
    voteData.isListLocked = false;

    document.getElementById('voterListText').value = '';
    syncHostUI();
    saveData();

    alert('æŠ•ç¥¨äººåå•å·²æ¸…ç©ºï¼');
}

        // ä¿å­˜æŠ•ç¥¨é€‰é¡¹
        function saveVoteOptions() {
            if (voteData.isVoteEnded) {
                alert('æŠ•ç¥¨å·²ç»ˆæ­¢ï¼Œæ— æ³•ä¿®æ”¹æŠ•ç¥¨é€‰é¡¹ï¼');
                return;
            }
            const text = document.getElementById('voteOptionsText').value.trim();
            voteData.voteOptions = text ? text.split('\n').map(item => item.trim()).filter(item => item) : [];
            saveData();
            alert('æŠ•ç¥¨é€‰é¡¹ä¿å­˜æˆåŠŸï¼');
        }

        // æš‚åœ/æ¢å¤æŠ•ç¥¨
        function toggleVotePause() {
            if (voteData.isVoteEnded) {
                alert('æŠ•ç¥¨å·²ç»ˆæ­¢ï¼Œæ— æ³•æš‚åœ/æ¢å¤ï¼');
                return;
            }
            voteData.isVotePaused = !voteData.isVotePaused;
            syncHostUI();
            saveData();
            alert(voteData.isVotePaused ? 'æŠ•ç¥¨å·²æš‚åœï¼' : 'æŠ•ç¥¨å·²æ¢å¤ï¼');
        }

        // æ–°å¢ï¼šç»ˆæ­¢æŠ•ç¥¨ï¼ˆä¸å¯é€†ï¼‰
        function toggleVoteEnd() {
            if (voteData.isVoteEnded) {
                alert('æŠ•ç¥¨å·²ç»ˆæ­¢ï¼Œæ— æ³•æ¢å¤ï¼');
                return;
            }
            if (!confirm('ç¡®å®šè¦ç»ˆæ­¢æŠ•ç¥¨å—ï¼Ÿç»ˆæ­¢åè®¿å®¢å°†æ— æ³•æŠ•ç¥¨/ä¿®æ”¹ç»“æœï¼Œæ­¤æ“ä½œä¸å¯é€†ï¼')) {
                return;
            }
            voteData.isVoteEnded = true;
            voteData.isVotePaused = true; // ç»ˆæ­¢åè‡ªåŠ¨æš‚åœ
            syncHostUI();
            saveData();
            alert('æŠ•ç¥¨å·²ç»ˆæ­¢ï¼è®¿å®¢æ— æ³•å†æŠ•ç¥¨æˆ–ä¿®æ”¹ç»“æœ');
        }

        // é‡ç½®æŠ•ç¥¨æ•°æ®
        function resetVote() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æŠ•ç¥¨æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            voteData.voteRecords = {};
            voteData.isListLocked = false;
            voteData.isVotePaused = false;
            voteData.isVoteEnded = false; // é‡ç½®æ—¶æ¢å¤ç»ˆæ­¢çŠ¶æ€
            voteData.allowVoteEdit = true; // é‡ç½®æ—¶æ¢å¤ä¿®æ”¹æƒé™
            syncHostUI();
            saveData();
            alert('æŠ•ç¥¨æ•°æ®å·²é‡ç½®ï¼');
        }

        // ä¿å­˜å…¬å¼€è®¾ç½®ï¼ˆå«ä¿®æ”¹æƒé™ï¼‰
        function savePublicSetting() {
            voteData.isResultPublic = document.getElementById('resultPublicCheck').checked;
            voteData.isDetailPublic = document.getElementById('detailPublicCheck').checked;
            // ä¿å­˜ä¿®æ”¹æƒé™è®¾ç½®
            voteData.allowVoteEdit = document.getElementById('allowEditCheck').checked;
            saveData();
            alert('å…¬å¼€è®¾ç½®åŠä¿®æ”¹æƒé™ä¿å­˜æˆåŠŸï¼');
        }

        // æˆ¿ä¸»æŸ¥çœ‹ç»“æœ
        function showHostResult() {
            const box = document.getElementById('hostResultBox');
            if (voteData.voteOptions.length === 0) {
                box.innerHTML = 'æš‚æ— æŠ•ç¥¨é€‰é¡¹';
                return;
            }
            const result = {};
            voteData.voteOptions.forEach(opt => result[opt] = 0);
            Object.values(voteData.voteRecords).forEach(selectedOpts => {
                const opts = Array.isArray(selectedOpts) ? selectedOpts : [selectedOpts];
                opts.forEach(opt => {
                    if (result[opt] !== undefined) result[opt]++;
                });
            });
            let html = '<div class="result-item"><strong>æŠ•ç¥¨æ€»ç»“æœï¼š</strong></div>';
            for (const [opt, count] of Object.entries(result)) {
                html += `<div class="result-item">${opt}ï¼š${count} ç¥¨</div>`;
            }
            html += '<div class="result-item" style="margin-top: 10px;"><strong>è¯¦ç»†æŠ•ç¥¨è®°å½•ï¼š</strong></div>';
            if (Object.keys(voteData.voteRecords).length === 0) {
                html += '<div class="result-item">æš‚æ— æŠ•ç¥¨è®°å½•</div>';
            } else {
                for (const [name, opts] of Object.entries(voteData.voteRecords)) {
                    const optText = Array.isArray(opts) ? opts.join('ã€') : opts;
                    html += `<div class="result-item">${name}ï¼š${optText}</div>`;
                }
            }
            box.innerHTML = html;
        }

        // ---------------------- è®¿å®¢åŠŸèƒ½ï¼ˆé€‚é…ä¿®æ”¹æƒé™+ç»ˆæ­¢çŠ¶æ€ï¼‰ ----------------------
        function visitorVerify() {
            const name = document.getElementById('visitorName').value.trim();
            const tip = document.getElementById('visitorVerifyTip');
            
            // åŸºç¡€éªŒè¯
            if (!name) {
                tip.textContent = 'è¯·è¾“å…¥å§“åï¼';
                return;
            }
            
            // ç»ˆæ­¢çŠ¶æ€éªŒè¯
            if (voteData.isVoteEnded) {
                tip.textContent = 'æŠ•ç¥¨å·²ç»ˆæ­¢ï¼Œæ— æ³•è¿›å…¥æŠ•ç¥¨ï¼';
                return;
            }
            
            // åå•é”å®šéªŒè¯
            if (!voteData.isListLocked) {
                tip.textContent = 'æŠ•ç¥¨åå•å°šæœªé”å®šï¼Œæš‚æ— æ³•æŠ•ç¥¨ï¼';
                return;
            }
            
            // å§“åéªŒè¯
            if (!voteData.voterList.includes(name)) {
                tip.textContent = 'æ‚¨çš„å§“åä¸åœ¨æŠ•ç¥¨åå•ä¸­ï¼';
                return;
            }
            
            // æš‚åœéªŒè¯
            if (voteData.isVotePaused) {
                tip.textContent = 'æŠ•ç¥¨å·²æš‚åœï¼Œæš‚æ— æ³•æŠ•ç¥¨ï¼';
                return;
            }
            
            // é€‰é¡¹éªŒè¯
            if (voteData.voteOptions.length === 0) {
                tip.textContent = 'æš‚æ— æŠ•ç¥¨é€‰é¡¹ï¼Œæ— æ³•æŠ•ç¥¨ï¼';
                return;
            }

            // éªŒè¯é€šè¿‡ï¼Œè¿›å…¥æŠ•ç¥¨é¡µ
            localStorage.setItem('current_visitor', name);
            switchTab('visitorVoteTab');
            renderVoteOptions(name);
        }

        // æ¸²æŸ“æŠ•ç¥¨é€‰é¡¹ï¼ˆé€‚é…ä¿®æ”¹æƒé™ï¼‰
        function renderVoteOptions(name) {
            const optionsBox = document.getElementById('voteOptionsBox');
            const submitBtn = document.getElementById('submitVoteBtn');
            const maxCount = voteData.voteMaxCount;
            const hasVoted = !!voteData.voteRecords[name];
            
            // å¦‚æœä¸å…è®¸ä¿®æ”¹ä¸”å·²æŠ•ç¥¨ï¼Œç¦ç”¨æŠ•ç¥¨é€‰é¡¹å’Œæäº¤æŒ‰é’®
            if (hasVoted && !voteData.allowVoteEdit) {
                const votedOpts = voteData.voteRecords[name];
                const optText = Array.isArray(votedOpts) ? votedOpts.join('ã€') : votedOpts;
                optionsBox.innerHTML = `<div style="color: #67c23a; font-size: 16px;">æ‚¨å·²æäº¤æŠ•ç¥¨ï¼š${optText}</div>
                                       <div class="tip">å½“å‰è®¾ç½®ä¸å…è®¸ä¿®æ”¹æŠ•ç¥¨ç»“æœ</div>`;
                submitBtn.disabled = true;
                submitBtn.classList.add('disabled');
                return;
            }

            // æ­£å¸¸æ¸²æŸ“æŠ•ç¥¨é€‰é¡¹
            let html = `<label>è¯·é€‰æ‹©æ‚¨çš„æŠ•ç¥¨é€‰é¡¹ï¼ˆæœ€å¤šå¯é€‰ ${maxCount} ä¸ªï¼‰ï¼š</label>`;
            const selectedOpts = voteData.voteRecords[name] || [];
            const selectedArr = Array.isArray(selectedOpts) ? selectedOpts : [selectedOpts];

            voteData.voteOptions.forEach((opt, index) => {
                const isChecked = selectedArr.includes(opt);
                const inputType = maxCount === 1 ? 'radio' : 'checkbox';
                html += `
                <div style="margin: 8px 0;">
                    <label>
                        <input type="${inputType}" name="${inputType === 'radio' ? 'voteOption' : 'voteOptionMulti'}" 
                               value="${opt}" ${isChecked ? 'checked' : ''} 
                               onchange="checkSelectCount()">
                        ${opt}
                    </label>
                </div>
                `;
            });
            optionsBox.innerHTML = html;
            document.getElementById('visitorNameTip').textContent = `å½“å‰æŠ•ç¥¨äººï¼š${name}`;
            
            // å·²æŠ•ç¥¨æç¤º
            if (hasVoted) {
                const optText = selectedArr.join('ã€');
                document.getElementById('voteSubmitTip').textContent = `æ‚¨å·²æŠ•ç¥¨ï¼š${optText}ï¼ˆå¯é‡æ–°æäº¤ä¿®æ”¹ï¼‰`;
                document.getElementById('voteSubmitTip').style.color = '#67c23a';
            }
            
            // å¯ç”¨æäº¤æŒ‰é’®
            submitBtn.disabled = false;
            submitBtn.classList.remove('disabled');
        }

        // æ£€æŸ¥å¤šé€‰æ•°é‡
        function checkSelectCount() {
            const maxCount = voteData.voteMaxCount;
            if (maxCount === 1) return;
            
            const checkedBoxes = document.querySelectorAll('input[name="voteOptionMulti"]:checked');
            const tip = document.getElementById('voteSubmitTip');
            
            if (checkedBoxes.length > maxCount) {
                checkedBoxes[checkedBoxes.length - 1].checked = false;
                tip.textContent = `æœ€å¤šåªèƒ½é€‰æ‹© ${maxCount} ä¸ªé€‰é¡¹ï¼`;
                tip.style.color = 'red';
            } else {
                tip.textContent = '';
            }
        }

        // è®¿å®¢æäº¤æŠ•ç¥¨ï¼ˆé€‚é…ä¿®æ”¹æƒé™+ç»ˆæ­¢çŠ¶æ€ï¼‰
        function submitVote() {
            const name = localStorage.getItem('current_visitor');
            const tip = document.getElementById('voteSubmitTip');
            
            // èº«ä»½éªŒè¯
            if (!name) {
                tip.textContent = 'èº«ä»½éªŒè¯å¤±æ•ˆï¼Œè¯·é‡æ–°éªŒè¯ï¼';
                return;
            }
            
            // ç»ˆæ­¢çŠ¶æ€éªŒè¯
            if (voteData.isVoteEnded) {
                tip.textContent = 'æŠ•ç¥¨å·²ç»ˆæ­¢ï¼Œæ— æ³•æäº¤ï¼';
                return;
            }
            
            // æš‚åœçŠ¶æ€éªŒè¯
            if (voteData.isVotePaused) {
                tip.textContent = 'æŠ•ç¥¨å·²æš‚åœï¼Œæ— æ³•æäº¤ï¼';
                return;
            }
            
            // ä¸å…è®¸ä¿®æ”¹ä¸”å·²æŠ•ç¥¨
            if (voteData.voteRecords[name] && !voteData.allowVoteEdit) {
                const optText = Array.isArray(voteData.voteRecords[name]) ? voteData.voteRecords[name].join('ã€') : voteData.voteRecords[name];
                tip.textContent = `æ‚¨å·²æŠ•ç¥¨ï¼š${optText}ï¼Œå½“å‰è®¾ç½®ä¸å…è®¸ä¿®æ”¹ï¼`;
                tip.style.color = 'red';
                return;
            }

            // è·å–é€‰ä¸­çš„é€‰é¡¹
            let selectedOpts = [];
            if (voteData.voteMaxCount === 1) {
                const selected = document.querySelector('input[name="voteOption"]:checked');
                if (!selected) {
                    tip.textContent = 'è¯·é€‰æ‹©æŠ•ç¥¨é€‰é¡¹ï¼';
                    return;
                }
                selectedOpts = [selected.value];
            } else {
                const checkedBoxes = document.querySelectorAll('input[name="voteOptionMulti"]:checked');
                if (checkedBoxes.length === 0) {
                    tip.textContent = 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ï¼';
                    return;
                }
                selectedOpts = Array.from(checkedBoxes).map(box => box.value);
            }

            // ä¿å­˜æŠ•ç¥¨è®°å½•
            voteData.voteRecords[name] = voteData.voteMaxCount === 1 ? selectedOpts[0] : selectedOpts;
            saveData();
            
            // æç¤ºæˆåŠŸ
            const optText = selectedOpts.join('ã€');
            tip.textContent = `æŠ•ç¥¨æˆåŠŸï¼æ‚¨é€‰æ‹©çš„æ˜¯ï¼š${optText}`;
            tip.style.color = '#67c23a';
            
            // å¦‚æœä¸å…è®¸ä¿®æ”¹ï¼Œç¦ç”¨æäº¤æŒ‰é’®
            if (!voteData.allowVoteEdit) {
                document.getElementById('submitVoteBtn').disabled = true;
                document.getElementById('submitVoteBtn').classList.add('disabled');
            }
            
            // è·³è½¬åˆ°ç»“æœé¡µ
            setTimeout(() => {
                showVisitorResult();
                switchTab('resultTab');
            }, 1500);
        }

        // è®¿å®¢æŸ¥çœ‹ç»“æœ
        function showVisitorResult() {
            const box = document.getElementById('publicResultBox');
            let html = '';
            if (voteData.isResultPublic) {
                const result = {};
                voteData.voteOptions.forEach(opt => result[opt] = 0);
                Object.values(voteData.voteRecords).forEach(selectedOpts => {
                    const opts = Array.isArray(selectedOpts) ? selectedOpts : [selectedOpts];
                    opts.forEach(opt => {
                        if (result[opt] !== undefined) result[opt]++;
                    });
                });
                html += '<div class="result-item"><strong>æŠ•ç¥¨æ€»ç»“æœï¼š</strong></div>';
                for (const [opt, count] of Object.entries(result)) {
                    html += `<div class="result-item">${opt}ï¼š${count} ç¥¨</div>`;
                }
            } else {
                html += '<div class="result-item">æŠ•ç¥¨ç»“æœæš‚æœªå…¬å¼€</div>';
            }
            if (voteData.isDetailPublic) {
                html += '<div class="result-item" style="margin-top: 10px;"><strong>è¯¦ç»†æŠ•ç¥¨è®°å½•ï¼š</strong></div>';
                if (Object.keys(voteData.voteRecords).length === 0) {
                    html += '<div class="result-item">æš‚æ— æŠ•ç¥¨è®°å½•</div>';
                } else {
                    for (const [name, opts] of Object.entries(voteData.voteRecords)) {
                        const optText = Array.isArray(opts) ? opts.join('ã€') : opts;
                        html += `<div class="result-item">${name}ï¼š${optText}</div>`;
                    }
                }
            } else if (voteData.isResultPublic) {
                html += '<div class="result-item" style="margin-top: 10px; color: #999;">è¯¦ç»†æŠ•ç¥¨è®°å½•æš‚æœªå…¬å¼€</div>';
            }
            box.innerHTML = html;
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = initData;
    </script>
</body>
</html>
