<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>多人协作抽签系统</title>

  <!-- LeanCloud SDK（必须在你的 JS 之前加载） -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>

  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass: rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#e6eef6;background:linear-gradient(180deg,#071021 0%, #081322 100%)}
    .container{max-width:980px;margin:32px auto;padding:24px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 12px;font-size:20px;color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    textarea{width:100%;height:230px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;resize:vertical}
    input[type=text], input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:var(--accent);color:#042022;text-decoration:none;border:none;cursor:pointer;font-weight:600}
    .mutebtn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .winners-list{margin-top:12px}
    .winner-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg, rgba(6,182,212,0.12), rgba(6,182,212,0.06));margin:6px 6px 0 0;border:1px solid rgba(6,182,212,0.12)}
    .animated-slot{height:56px;display:flex;align-items:center;justify-content:center;margin-bottom:6px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:18px}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .file-row{display:flex;gap:8px;align-items:center}
  </style>
</head>

<body>
  <div class="container">
    <h1>多人协作抽签系统</h1>
    <p class="small">支持：多人在线填写名字、自动同步、管理员抽签与清空功能。</p >

    <div class="grid">

      <!-- 左侧主卡片 -->
      <div class="card">
        <label>1) 当前名单（多人编辑自动同步）</label>
        <textarea id="namesInput" placeholder="自动同步云端名单..." disabled></textarea>

        <div style="margin-top:10px" class="file-row">
          <button class="btn" id="addMyNameBtn">我也要提交名字</button>
          <button class="mutebtn" id="clearNamesBtn" disabled>清空名单（房主）</button>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <label>2) 抽签设置（房主可用）</label>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <div style="flex:1">
            <label class="small">抽取人数</label>
            <input id="count" type="number" min="1" value="1" />
          </div>
        </div>

        <button class="btn" id="drawBtn" disabled>开始抽签（房主）</button>
      </div>

      <!-- 右侧显示区 -->
      <div class="card">
        <label>抽签结果</label>
        <div id="slots"></div>
        <div id="winners" class="winners-list"></div>

        <div style="margin-top:12px">
          <label class="small">系统日志</label>
          <pre id="log" style="max-height:140px;overflow:auto;padding:8px;background:rgba(0,0,0,0.15);border-radius:8px;color:var(--muted)"></pre>
        </div>
      </div>

    </div>
    <script>
    /********************************************
     *  0. 初始化 LeanCloud
     ********************************************/
    AV.init({
      appId: "awjrq2pnF6yDBX2QT7Sq1dHQ-gzGzoHsz",  
      appKey: "WY6uq9q4hPthkwKX5JIHrlYk",
      serverURL: "https://awjrq2pn.lc-cn-n1-shared.com"
    });

    /********************************************
     * 1. 全局变量 / 元素
     ********************************************/
    let isOwner = false;   // 你输入房主密码后变为 true
    const ROOM_ID = "global-room";  // 所有人共享同一房间名单

    const namesInput = document.getElementById("namesInput");
    const addMyNameBtn = document.getElementById("addMyNameBtn");
    const clearNamesBtn = document.getElementById("clearNamesBtn");
    const drawBtn = document.getElementById("drawBtn");
    const countInput = document.getElementById("count");

    const logBox = document.getElementById("log");
    const slots = document.getElementById("slots");
    const winnersDiv = document.getElementById("winners");

    const NameList = AV.Object.extend("NameList");  // 数据表

    /********************************************
     * 2. 日志系统
     ********************************************/
    function log(msg){
      const time = new Date().toLocaleTimeString();
      logBox.textContent = `${time}  ${msg}\n` + logBox.textContent;
    }

    /********************************************
     * 3. 房主验证（自动弹窗）
     ********************************************/
    (function(){
        const pw = prompt("请输入房主口令（清空名单 / 抽签权限）：\n\n访客点取消即可加入名单");
        if(pw === "666888"){   // ← 你可以自定义房主密码
           isOwner = true;
           clearNamesBtn.disabled = false;
           drawBtn.disabled = false;
           log("已进入房主模式");
        } else {
           isOwner = false;
           drawBtn.disabled = true;
          /********************************************
     * 4. 从云端读取名单（自动同步显示）
     ********************************************/
    async function loadNamesFromCloud(){
        const query = new AV.Query("NameList");
        query.equalTo("room", ROOM_ID);
        query.ascending("createdAt");

        const results = await query.find();
        const list = results.map(r => r.get("name"));

        namesInput.value = list.join("\n");
        log(`云端名单已加载，总人数：${list.length}`);
    }

    // 页面打开时加载一次
    loadNamesFromCloud();


    /********************************************
     * 5. 实时同步（多人在线实时刷新）
     ********************************************/
    async function enableRealtime(){
        const query = new AV.Query("NameList");
        query.equalTo("room", ROOM_ID);

        const liveQuery = await query.subscribe();
        liveQuery.on("create", loadNamesFromCloud);
        liveQuery.on("update", loadNamesFromCloud);
        liveQuery.on("delete", loadNamesFromCloud);

        log("已开启实时同步");
    }
    enableRealtime();


    /********************************************
     * 6. 访客：添加自己的名字到云端
     ********************************************/
    addMyNameBtn.addEventListener("click", async ()=>{
        const name = prompt("请输入你的名字：");
        if(!name){ return; }

        const obj = new NameList();
        obj.set("room", ROOM_ID);
        obj.set("name", name.trim());

        await obj.save();

        log(`你添加了：${name}`);
        loadNamesFromCloud();
    });


    /********************************************
     * 7. 房主：一键清空名单
     ********************************************/
    clearNamesBtn.addEventListener("click", async ()=>{
        if(!isOwner){
            alert("你不是房主，不能清空名单");
            return;
        }

        if(!confirm("确定清空所有名字？")) return;

        const query = new AV.Query("NameList");
        query.equalTo("room", ROOM_ID);
        const results = await query.find();
        await AV.Object.destroyAll(results);

        namesInput.value = "";
        log("名单已被房主清空");
    });


    /********************************************
     * 8. 抽签动画 + 房主抽签按钮
     ********************************************/
    function displaySlots(n){
        slots.innerHTML = "";
        for(let i=0;i<n;i++){
            const div = document.createElement("div");
            div.className = "animated-slot";
            div.textContent = "— 抽签槽 " + (i+1);
            slots.appendChild(div);
        }
    }

    function shuffle(arr){
        let a = arr.slice();
        for(let i=a.length-1;i>0;i--){
            const j = Math.floor(Math.random()*(i+1));
            [a[i],a[j]] = [a[j],a[i]];
        }
        return a;
    }

    function animateReveal(names){
        const slotEls = Array.from(slots.children);
        const pool = namesInput.value.split("\n").filter(Boolean);

        winnersDiv.innerHTML = "";

        slotEls.forEach((el, idx)=>{
            let rounds = 18;
            let r = 0;
            const timer = setInterval(()=>{
                el.textContent = pool[Math.floor(Math.random()*pool.length)] || "—";
                r++;
                if(r >= rounds){
                    clearInterval(timer);
                    el.textContent = names[idx];

                    const pill = document.createElement("span");
                    pill.className = "winner-pill";
                    pill.textContent = (idx+1)+". "+names[idx];
                    winnersDiv.appendChild(pill);
                }
            }, 40);
        });
    }


    /********************************************
     * 9. 房主点击抽签
     ********************************************/
    drawBtn.addEventListener("click", ()=>{
        if(!isOwner){
            alert("你不是房主，不能抽签");
            return;
        }

        const pool = namesInput.value.split("\n").filter(Boolean);
        if(pool.length === 0){
            alert("名单为空");
            return;
        }

        const n = Math.max(1, parseInt(countInput.value));
        displaySlots(n);

        const shuffled = shuffle(pool).slice(0, n);
        animateReveal(shuffled);

        log(`房主抽取了 ${n} 人`);
    });

    </script>
  </div> <!-- container end -->
</body>
</html>
           clearNamesBtn.disabled = true;
           log("访客模式：你可以添加名字，但不能抽签或清空");
        }
    })();
